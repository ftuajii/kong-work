name: Container Security Scan

on:
  schedule:
    # æ¯Žé€±æœˆæ›œæ—¥ 9:00 JST (00:00 UTC) ã«å®šæœŸã‚¹ã‚­ãƒ£ãƒ³
    - cron: "0 0 * * 1"
  workflow_dispatch:
    inputs:
      image_tag:
        description: "ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚° (ä¾‹: 3.10)"
        required: false
        default: "3.10"
        type: string
  workflow_call:
    inputs:
      image_tag:
        description: "ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚° (ä¾‹: 3.10)"
        required: false
        default: "3.10"
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ftuajii/bookinfo/kong-gateway

jobs:
  scan-kong-image:
    name: Scan Kong Gateway Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up image tag
        id: tags
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=3.10" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Kong Gateway image
        run: |
          echo "ðŸ” Pulling image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.tag }}"
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.tag }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.tag }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0" # ã‚¹ã‚­ãƒ£ãƒ³çµæžœã«é–¢ã‚ã‚‰ãšç¶šè¡Œ

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Trivy for human-readable output
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.tag }}
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"

      - name: Generate vulnerability report
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ã‚¤ãƒ¡ãƒ¼ã‚¸**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š è„†å¼±æ€§ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Trivyã®ã‚¹ã‚­ãƒ£ãƒ³çµæžœã‚’é›†è¨ˆ
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --format json \
            --severity CRITICAL,HIGH,MEDIUM \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.tag }} \
            > scan-results.json || true

          if [ -f scan-results.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' scan-results.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' scan-results.json)
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' scan-results.json)
            
            echo "| æ·±åˆ»åº¦ | ä»¶æ•° |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ CRITICAL | ${CRITICAL:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  HIGH | ${HIGH:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ MEDIUM | ${MEDIUM:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
            echo "è©³ç´°ãªè„†å¼±æ€§æƒ…å ±ã¯[Security ã‚¿ãƒ–](https://github.com/${{ github.repository }}/security/code-scanning)ã§ç¢ºèªã§ãã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for critical vulnerabilities
        run: |
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' scan-results.json)

          if [ "${CRITICAL:-0}" -gt 0 ]; then
            echo "âš ï¸ CRITICALè„†å¼±æ€§ãŒ ${CRITICAL} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            echo "æ—©æ€¥ãªå¯¾å¿œãŒå¿…è¦ã§ã™!"
            # PRä½œæˆæ™‚ã®ã¿failã«ã™ã‚‹ (mainã¸ã®pushã¯è­¦å‘Šã®ã¿)
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              exit 1
            fi
          else
            echo "âœ… CRITICALè„†å¼±æ€§ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [scan-kong-image]
    if: always()

    steps:
      - name: Overall summary
        run: |
          echo "## ðŸŽ¯ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Kong Gateway ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. [Security ã‚¿ãƒ–](https://github.com/${{ github.repository }}/security)ã§è©³ç´°ã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "2. CRITICALè„†å¼±æ€§ãŒã‚ã‚‹å ´åˆã¯å„ªå…ˆçš„ã«å¯¾å¿œ" >> $GITHUB_STEP_SUMMARY
          echo "3. å®šæœŸçš„ãªã‚¤ãƒ¡ãƒ¼ã‚¸æ›´æ–°ã‚’å®Ÿæ–½" >> $GITHUB_STEP_SUMMARY
