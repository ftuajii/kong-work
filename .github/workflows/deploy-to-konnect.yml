name: Deploy to Konnect

on:
    push:
        branches:
            - main
        paths:
            - "kong/configs/kong.yaml"
            - ".github/workflows/deploy-to-konnect.yml"

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup deck
              run: |
                  curl -sL https://github.com/Kong/deck/releases/download/v1.49.2/deck_1.49.2_linux_amd64.tar.gz -o deck.tar.gz
                  tar -xf deck.tar.gz -C /tmp
                  sudo mv /tmp/deck /usr/local/bin/
                  deck version

            - name: Validate configuration
              run: |
                  deck gateway validate \
                    --state kong/configs/kong.yaml

            - name: Show diff (Dry-run)
              env:
                  KONNECT_TOKEN: ${{ secrets.KONNECT_TOKEN }}
                  KONNECT_CONTROL_PLANE_NAME: ${{ secrets.KONNECT_CONTROL_PLANE_NAME }}
              run: |
                  echo "ðŸ“Š Changes to be deployed:"
                  deck gateway diff \
                    --konnect-token "$KONNECT_TOKEN" \
                    --konnect-control-plane-name "$KONNECT_CONTROL_PLANE_NAME" \
                    --state kong/configs/kong.yaml || true

            - name: Deploy to Konnect
              env:
                  KONNECT_TOKEN: ${{ secrets.KONNECT_TOKEN }}
                  KONNECT_CONTROL_PLANE_NAME: ${{ secrets.KONNECT_CONTROL_PLANE_NAME }}
              run: |
                  echo "ðŸš€ Deploying to Konnect..."
                  deck gateway sync \
                    --konnect-token "$KONNECT_TOKEN" \
                    --konnect-control-plane-name "$KONNECT_CONTROL_PLANE_NAME" \
                    --state kong/configs/kong.yaml

            - name: Deployment success
              run: |
                  echo "âœ… Successfully deployed to Konnect!"
                  echo "ðŸ“¦ Control Plane: ${{ secrets.KONNECT_CONTROL_PLANE_NAME }}"
