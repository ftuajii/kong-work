name: Publish API Spec to Konnect Dev Portal

on:
  workflow_call:
    inputs:
      publish_version:
        description: "API Product Versionã‚’å…¬é–‹çŠ¶æ…‹ã«ã™ã‚‹"
        required: false
        default: "true"
        type: string
  workflow_dispatch:
    inputs:
      publish_version:
        description: "API Product Versionã‚’å…¬é–‹çŠ¶æ…‹ã«ã™ã‚‹"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  publish-spec:
    name: Publish API Specification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate OpenAPI Spec
        run: |
          # OpenAPIä»•æ§˜ã®åŸºæœ¬çš„ãªæ¤œè¨¼
          if [ ! -f "kong/specs/openapi.yaml" ]; then
            echo "âŒ OpenAPI Specãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # YAMLã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ (jqã‚’ä½¿ç”¨)
          cat kong/specs/openapi.yaml | grep -q "openapi:" || {
            echo "âŒ æœ‰åŠ¹ãªOpenAPIä»•æ§˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
            exit 1
          }

          echo "âœ… OpenAPI Specæ¤œè¨¼å®Œäº†"

      - name: Publish API Spec to Konnect
        env:
          KONNECT_TOKEN: ${{ secrets.KONNECT_TOKEN }}
          API_PRODUCT_ID: ${{ secrets.API_PRODUCT_ID }}
          VERSION_ID: ${{ secrets.VERSION_ID }}
          KONNECT_API_ENDPOINT: ${{ vars.KONNECT_API_ENDPOINT || 'https://us.api.konghq.com' }}
          PUBLISH_VERSION: ${{ github.event.inputs.publish_version || 'false' }}
          SPEC_FILE: kong/specs/openapi.yaml
        run: |
          chmod +x scripts/publish-api-spec.sh
          ./scripts/publish-api-spec.sh

      - name: Summary
        if: success()
        run: |
          echo "## âœ… API Specå…¬é–‹æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "APIä»•æ§˜ãŒKonnect Dev Portalã«å…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ è©³ç´°" >> $GITHUB_STEP_SUMMARY
          echo "- **API Product ID**: \`${{ secrets.API_PRODUCT_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version ID**: \`${{ secrets.VERSION_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Spec File**: \`kong/specs/openapi.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ãƒªãƒ³ã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "- [Konnect Console](https://cloud.konghq.com/)" >> $GITHUB_STEP_SUMMARY
          echo "- [API Products](https://cloud.konghq.com/api-products)" >> $GITHUB_STEP_SUMMARY

      - name: Failure notification
        if: failure()
        run: |
          echo "## âŒ API Specå…¬é–‹å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "APIä»•æ§˜ã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
